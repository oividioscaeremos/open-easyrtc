<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sompo Sigorta - Canlı Destek</title>
    <link rel="stylesheet" href="css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="css/call.css">
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/4.5.95/css/materialdesignicons.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../easyrtc/easyrtc.js"></script>
    <script type="text/javascript" src="../easyrtc/easyrtc_ft.js"></script>
    <script type="text/javascript" src="../easyrtc/labs/easyrtc_recorder.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    <script src="https://jsconsole.com/js/remote.js?d522a25f-c5ab-4c16-8f16-a2ec3214285c"></script>




</head>

<body onload="connect()">
    <div id="mySidenav" class="sidenav drawr-container">
        <div>
            <img src="http://www.ilkeratabay.com/wp-content/uploads/2019/11/90derece.png" height="32" width="32"
                id="rotater" />
            <img id="rotaterImage" style="left: -99999px; position: absolute;" />
        </div>
        <div id="drawr-container" style="margin-left:80px; margin-right:80px;border:2px dotted gray;">
            <canvas id="touchUpCanvasForDrawing" class="demo-canvas drawr-test1"></canvas>
        </div>
        <div>
            <button id="saveChanges">Kaydet</button>
        </div>
    </div>
    <div id="wholeContent">
        <div id="peerZone" style="width: 100%; height: 20%; margin-top: 0px;">
        </div>
        <div id="recordings">
            <a id="selfDownloadLink"></a>
            <a id="callerDownloadLink"></a>
        </div>
        <div id="seperator" /><br><br>

        <div class="container" style="width:100%; height:100%;" style="background-color: red;">
            <div class="row md-center" id="cameras" style="background-color: aqua;">
                <video autoplay="autoplay" playsinline="playsinline" id="selfVideo" class="easyrtcMirror" muted></video>
                <video autoplay="autoplay" playsinline="playsinline" id="callerVideo" muted></video>
            </div>
            <div id="buttonHolder" class="text-center">
                <div id="mobile-buttons" class="justify-content-center">
                    <button id="change-camera-source" class=" btn btn-primary">KAMERAYI DEĞİŞTİR</button>
                    <button id="myBtn" class=" btn btn-primary">Fotoğraf Çek</button>
                </div>
                <div id="desktop-buttons" class="justify-content-center">
                    <button id="start-call" class=" btn btn-primary" onclick="performCall(theirID);" disabled>ARAMAYI
                        BAŞLAT</button>
                    <button id="end-call" class=" btn btn-primary" onclick="disconnect();">ARAMAYI BİTİR</button>
                    <button id="startRecording" class=" btn btn-primary" onclick="startRecording();">KAYDI
                        BAŞLAT</button>
                    <button id="stopRecording" class=" btn btn-primary" onclick="endRecording();">KAYDI BİTİR</button>
                    <button class=" btn btn-primary" onclick="getDownloadLinksForCall();">İNDİRME
                        LİNKİNİ AL</button>
                </div>
            </div>

            <!-- Trigger/Open The Modal -->
            <!-- Fotoğraf Çekmek İçin Kullanılacak Olan Modal (Mobil Tarafta)-->
            <div id="myModal" class="modal" style="z-index: 99;">
                <!-- Modal content -->
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="close">&times;</span>
                        <h4>Sompo Sigorta - Canlı Destek</h4>
                    </div>
                    <div class="modal-body">
                        <video id="video" style="margin: 0 auto; width: 100%; height: auto;" autoplay muted></video>
                        <div><button id='take-a-photo' onclick="gotMedia()">Fotoğraf Çek</button></div>
                    </div>
                    <div class="modal-footer">
                        <h3></h3>
                    </div>
                </div>
            </div>
            <!-- Fotoğraf Çekmek İçin Kullanılacak Modal Sonu -->
        </div>

        <div id="otherClients"></div>
    </div>
    </div>
    <script type="text/javascript" src="js/drawr.js"></script>
    <script src="js/app.js"></script>


    <script>
        let ourID = "";
        let theirID = "";
        let frontMediaStreamTrack,
            backMediaStreamTrack,
            backCameraID = '',
            frontCameraID = '';

        $(document).ready(function () {

            document.getElementById('change-camera-source').addEventListener('click', function () {
                //alert('merhaba dunyali' + currentCameraState);
                changeCamera(currentCameraState);
            });

            modal_PhotoTaker();
        });


        // Get the modal
        var modal = document.getElementById("myModal");


        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal 
        btn.onclick = function () {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            } else if (event.target == touchUpModal) {
                touchUpModal.style.display = "none";
                document.getElementById('touchUpCanvasForDrawing').undoStack = [];
            }
        }

        function modal_PhotoTaker() {
            // camera usage
            // Grab elements, create settings, etc.
            var video = document.getElementById('video');
            let cameraList = [
                [],
                []
            ];
            // Get access to the camera!
            navigator.mediaDevices.getUserMedia({
                video:true,
                audio:true
            }).then(
                function(){
                    navigator.mediaDevices.enumerateDevices().then(
                        function (values) {
                            alert(JSON.stringify(values));
                            values.forEach(
                                v => {
                                    if (v.kind == "videoinput" && v.label.toLocaleLowerCase('TR').match(/arka|back/g).length > 0) {
                                        cameraList[0].push(v);
                                    } else if (v.kind == "videoinput" && v.label.toLocaleLowerCase('TR').match(/ön|front/g).length > 0) {
                                        cameraList[1].push(v);
                                    }
                                }
                            );
                            if (cameraList[0].length == 0) {
                                let constraints = {
                                    video: {
                                        deviceId: cameraList[1][0].deviceId
                                    },
                                    audio: undefined
                                }
                                navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                                    video.srcObject = stream;
                                    frontMediaStreamTrack = stream.getVideoTracks()[0];
                                    video.play();

                                });
                            } else {
                                let constraints = {
                                    video: {
                                        deviceId: cameraList[0][0].deviceId
                                    },
                                    audio: undefined
                                }
                                navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                                    video.srcObject = stream;
                                    backMediaStreamTrack = stream.getVideoTracks()[0];
                                    video.play();
                                });
                            }
                        }
                    )
                }
            );

            /*easyrtc.getVideoSourceList(function (list) {
                        let constraints, cameraName, label, found = false;
                        console.log(list);
                        list.map(listElement => {
                            console.log(listElement.label);
                            if (listElement.label.indexOf('back') > 0 || list.label.indexOf('Arka') > 0) {

                                constraints = {
                                    video: {
                                        deviceId: cameraID
                                    },
                                    audio: undefined
                                }
                                navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                                    video.srcObject = stream;
                                    backMediaStreamTrack = stream.getVideoTracks()[0];

                                    video.play();

                                });

                                found = true;
                            }
                        });


                        list.map(listElement => {
                            if (listElement.label.indexOf('front') > 0 || list.label.indexOf('Ön') > 0) {
                                constraints = {
                                    video: {
                                        deviceId: cameraID
                                    },
                                    audio: undefined
                                }
                                navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {

                                    frontMediaStreamTrack = stream.getVideoTracks()[0];
                                    if (!found) {
                                        video.srcObject = stream;
                                        video.play();
                                    }
                                });

                                found = true;
                            }
                        });



                        /*for (let i = 0; i < list.length; i++) {
                    alert(JSON.stringify(list[i]));
                    if (list[i].label.indexOf('back') > 0 || list[i].label.indexOf('Arka') > 0) {
                        cameraID = list[i].deviceId;
                        backCameraID = list[i].deviceId;
                        cameraName = "back";
                        constraints = {
                            video: {
                                deviceId: cameraID ? {
                                    exact: cameraID
                                } : undefined
                            },
                            audio: undefined
                        };
                        label = list[i].label;
                        break;
                    } else {
                        cameraID = list[i].deviceId;
                        frontCameraID = list[i].deviceId;
                        cameraName = "front";
                        constraints = {
                            video: {
                                width: 720,
                                height: 1080,
                                deviceId: cameraID ? {
                                    exact: cameraID
                                } : undefined
                            },
                            audio: undefined
                        };
                        label = list[i].label;

                    }

                    navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                        video.srcObject = stream;
                        if (cameraName == "back") {
                            backMediaStreamTrack = stream.getVideoTracks()[0];
                        } else {
                            frontMediaStreamTrack = stream.getVideoTracks()[0];
                        }
                        console.log(backMediaStreamTrack);
                        console.log(frontMediaStreamTrack);
                        console.log(stream);
                        let playPromise = video.play();
                        if (playPromise != undefined) {
                            playPromise.then(_ =>
                                video.play()
                            );
                        }

                    });
                }
            });

            });*/
        }
    </script>

    <script src="js/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
    </script>
</body>

</html>